name: Deploy Production Final

on:
  workflow_dispatch: 

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend (Bitwarden Web Vault)
        run: |
          mkdir -p public
          wget -q "https://github.com/dani-garcia/bw_web_builds/releases/download/v2025.12.0/bw_web_v2025.12.0.tar.gz"
          tar -xzf "bw_web_v2025.12.0.tar.gz" -C public/
          find public/web-vault -type f -name '*.map' -delete
          echo "✅ Frontend UI downloaded and extracted"

      - name: Patch wrangler.toml
        run: |
          # 1. Ganti semua kata 'vault1' menjadi 'warden-db'
          # Ini akan mengubah 'binding' dan 'database_name' sekaligus dalam satu langkah
          sed -i 's/vault1/warden-db/g' wrangler.toml
          
          # 2. Injeksi ID Database dari Secret
          sed -i 's/${D1_DATABASE_ID}/${{ secrets.D1_DATABASE_ID }}/g' wrangler.toml
          
          # 3. Sync KV Namespace ID
          sed -i '/binding = "ATTACHMENTS_KV"/a id = "${{ secrets.ATTACHMENTS_KV_ID }}"' wrangler.toml
          
          echo "✅ All references to vault1 have been purged and replaced with warden-db"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install worker-build
        run: cargo install worker-build --version 0.7.1

      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4.63.0" 
          command: deploy
        env:
          DISABLE_USER_REGISTRATION: ${{ secrets.DISABLE_USER_REGISTRATION || 'false' }}
