name: Deploy Production Final

on:
  workflow_dispatch: 

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare (Prod)
    env:
      WORKER_BUILD_VERSION: "0.7.1"
      WRANGLER_VERSION: "4.54.0"
      BW_WEB_VERSION: ${{ vars.BW_WEB_VERSION || 'v2025.12.0' }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend (Bitwarden Web Vault)
        run: |
          set -euo pipefail
          TAG="${BW_WEB_VERSION}"
          if [ "${TAG}" = "latest" ]; then
            TAG="$(curl -s https://api.github.com/repos/dani-garcia/bw_web_builds/releases/latest | jq -r .tag_name)"
          fi
          echo "üì¶ Downloading frontend version: ${TAG}"
          wget -q "https://github.com/dani-garcia/bw_web_builds/releases/download/${TAG}/bw_web_${TAG}.tar.gz"
          tar -xzf "bw_web_${TAG}.tar.gz" -C public/
          if [ ! -d "public/web-vault" ]; then
            echo "‚ùå Expected ./public/web-vault after extracting" >&2
            exit 1
          fi
          find public/web-vault -type f -name '*.map' -delete
          rm -f "bw_web_${TAG}.tar.gz"

      - name: Apply web vault overrides
        run: bash scripts/apply-web-vault-overrides.sh public/web-vault

      - name: Patch wrangler.toml
        run: |
          set -euo pipefail
          
          sed -i "s/\${D1_DATABASE_ID}/${{ secrets.D1_DATABASE_ID }}/g" wrangler.toml
          sed -i 's/database_name = "vault1"/database_name = "${{ secrets.D1_DATABASE_NAME }}"/g' wrangler.toml
          sed -i '/binding = "ATTACHMENTS_KV"/a \id = "${{ secrets.ATTACHMENTS_KV_ID }}"' wrangler.toml

          echo "‚úÖ wrangler.toml synchronized with your custom database names."

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install worker-build
        run: cargo install --locked -q worker-build --version "${WORKER_BUILD_VERSION}"

      - name: Apply D1 database migrations (With Auto-Skip)
        run: |
          set -euo pipefail
          WRANGLER="npx --yes wrangler@${WRANGLER_VERSION}"
          DB_NAME="${{ secrets.D1_DATABASE_NAME }}"
          
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "üîÑ Mencoba apply migrasi (percobaan $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            
            # Simpan output ke file untuk dianalisa jika gagal
            if $WRANGLER d1 migrations apply "$DB_NAME" --remote 2>&1 | tee migration_output.txt; then
              echo "‚úÖ Semua migrasi berhasil diterapkan!"
              exit 0
            fi
            
            # Cek jika errornya karena kolom sudah ada (duplicate column)
            if grep -q "duplicate column name" migration_output.txt; then
              # Ambil nama file SQL yang gagal dari log
              FAILED_MIGRATION=$(grep -oP "Migration \K[0-9]+_[a-zA-Z0-9_]+\.sql(?= failed)" migration_output.txt)
              
              if [ -z "$FAILED_MIGRATION" ]; then
                echo "‚ùå Gagal mengidentifikasi file migrasi yang error."
                cat migration_output.txt
                exit 1
              fi
              
              echo "‚ö†Ô∏è File '$FAILED_MIGRATION' sudah ada di DB. Menandai sebagai 'Applied'..."
              
              $WRANGLER d1 execute "$DB_NAME" --remote --command "
                CREATE TABLE IF NOT EXISTS d1_migrations (
                  id INTEGER PRIMARY KEY AUTOINCREMENT,
                  name TEXT UNIQUE NOT NULL,
                  applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
                );
                INSERT OR IGNORE INTO d1_migrations (name) VALUES ('$FAILED_MIGRATION');
              "
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
            else
              echo "‚ùå Terjadi error migrasi yang tidak terduga:"
              cat migration_output.txt
              exit 1
            fi
          done

      - name: Bootstrap D1 schema
        run: |
          set -euo pipefail
          WRANGLER="npx --yes wrangler@${WRANGLER_VERSION}"
          DB_NAME="${{ secrets.D1_DATABASE_NAME }}"
          
          # Gunakan format output text biasa untuk cek tabel agar lebih stabil daripada JQ
          TABLE_COUNT=$($WRANGLER d1 execute "${DB_NAME}" --remote --command "SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name NOT IN ('d1_migrations');" --json | jq '.[0].results[0]["COUNT(*)"]')
          
          if [ "$TABLE_COUNT" = "0" ]; then
            echo "üÜï Bootstrapping database..."
            $WRANGLER d1 execute "${DB_NAME}" --remote --file sql/schema.sql
          fi

      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION }} 
          command: deploy
