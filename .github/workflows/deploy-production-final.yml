name: Deploy Production Final

on:
  workflow_dispatch: 

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend (Bitwarden Web Vault)
        run: |
          mkdir -p public
          wget -q "https://github.com/dani-garcia/bw_web_builds/releases/download/v2025.12.0/bw_web_v2025.12.0.tar.gz"
          tar -xzf "bw_web_v2025.12.0.tar.gz" -C public/
          find public/web-vault -type f -name '*.map' -delete
          echo "✅ Frontend UI downloaded and extracted"

      - name: Patch wrangler.toml
        run: |
          # 1. Ganti semua binding D1 (apapun namanya) menjadi "DB"
          sed -i '/\[\[d1_namespaces\]\]/,/binding =/ s/binding = .*/binding = "DB"/' wrangler.toml
          
          # 2. Pastikan database_name menunjuk ke "warden-db"
          sed -i 's/database_name = .*/database_name = "warden-db"/g' wrangler.toml
          
          # 3. Suntikkan ID Database yang sebenarnya dari Secret
          # Kita pastikan baris database_id diisi dengan ID asli Anda
          sed -i 's/database_id = .*/database_id = "${{ secrets.D1_DATABASE_ID }}"/g' wrangler.toml
          
          # 4. Sync KV Namespace ID (seperti sebelumnya)
          sed -i '/binding = "ATTACHMENTS_KV"/a id = "${{ secrets.ATTACHMENTS_KV_ID }}"' wrangler.toml
          
          echo "✅ wrangler.toml patched: Binding=DB, Name=warden-db, ID=Injected"
          cat wrangler.toml | grep -A 5 "d1_namespaces"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install worker-build
        run: cargo install worker-build --version 0.7.1

      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4.63.0" 
          command: deploy
        env:
          DISABLE_USER_REGISTRATION: ${{ secrets.DISABLE_USER_REGISTRATION || 'false' }}
